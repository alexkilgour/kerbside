#!/usr/bin/env node

const chalk = require('chalk');
const moment = require('moment-timezone');
const kerbside = require('../index');
const locations = kerbside.locations();

const help = `
  USAGE
    kerbside <args>
      -l, --location <n>    Location number (default: 0)
	  -d, --days <n>        Number of days to show (default: all)
	  -t, --today <b>       Show traders for ONLY today (default: false)
      -j, --json <b>        Display as JSON (default: false)
      -h, --help            Show this help message

  TRADERS
${locationsToString(locations)}
`

const args = require('minimist')(process.argv.slice(2), {
	alias: {
		'l': 'location',
		'd': 'days',
		't': 'today',
		'j': 'json',
		'h': 'help'
	},
	default: {
		'l': '0',
		'd': null,
		'j': false,
		't': false
	}
});

// Print the results
function printResults (json) {
	json.data.forEach(el => {
		console.log(chalk`\n{red ${el.date}}`);
		Object.keys(el.traders).forEach(trader => {
			console.log(chalk`  {blue ${trader}} - {green ${el.traders[trader]}}`);
		});
	});
};

// format the JSON based on args
function formatJson (json, days, today) {
	if (today) {
		const today = moment().tz('Europe/London').format('dddd Do MMMM');
		const todayData = json.data.find(o => o.date === today);
		return {
			data: [todayData],
			location: json.location
		}
	} else if (days) {
		if (days >= json.data.length) {
			return json;
		} else {
			return {
				data: json.data.slice(0, days),
				location: json.location
			}
		}
	}

	return json;
};

// Stringify the location array
function locationsToString (locations) {
	return locations.map((x, i) => `    ${i}: ${x}\n`)
		.toString()
			.replace(/,/g, '');
};

// Print the help
if (args.help) {
	console.log(help)
	process.exit()
}

kerbside.traders(args.location).then(results => {
	if (results && results.data.length === 0) {
		console.log(`Sorry, we couldn\'t find any traders for ${locations[args.location]}`);
	} else {
		const formattedJson = formatJson(results, args.days, args.today);
		if (args.json) {
			console.log(formattedJson);
		} else {
			printResults(formattedJson);
		}
	}
});
